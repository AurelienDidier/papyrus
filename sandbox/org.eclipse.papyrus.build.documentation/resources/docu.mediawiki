== Requirements to manage a build ==  
* be a Papyrus committer (of course)
* have a non-restricted shell access to build.eclipse.org (log a bug to Community/Server to obtain SSH access: see [http://bugs.eclipse.org/bugs/show_bug.cgi?id=366699 bug 366699]). To know if your shell is restricted, try to execute linux commands and see if you get disconnected.
* have write rights on dev.eclipse.org:/cvsroot/callisto (log a bug to Community/CVS to get it, see [http://bugs.eclipse.org/bugs/show_bug.cgi?id=366727 bug 366727])
**use extssh and not pserver for this connection
* have rights to launch this job : https://hudson.eclipse.org/hudson/job/juno.runAggregator/ (should come with the previous rights)
* have write access to /home/data/httpd/download.eclipse.org/modeling/mdt/papyrus (should come with the Papyrus committer rights)


== Releng Project ==
The papyrus releng project is called : '''org.eclipse.mdt.papyrus.releng.buckminster'''

[[Image:releng.png]]

*'''serverConfig :''' (after each modification, the scripts in this directory must be copied into "/shared/modeling/mdt/papyrus" where they run) 
**'''addDownloadStats.sh :''' script that enables download statistics on an update site
**'''addDownloadStats.xsl :''' XSL transformation that enables download statistics on an update site (it contains the list of features that must be part of the stats)
**'''cronPromote.sh :''' a script that runs as a cron on build.eclipse.org to publish the latest nightly
**'''release_0.8.sh :''' used to publish a release
*'''xsl :'''
**'''psf :''' to build the psf from a Buckminster ''bill of materials''. The BOM is produced by Buckminster when importing all the dependencies, and contains a list of these dependencies.
***'''bom2repository.xsl :''' transforms a Buckminster BOM into a list of dependent repositories
***'''build.xml :''' used for testing the generation of the PSFs
***'''papyrus_bom.xml:''' used for testing the generation of the PSFs
***'''repository2subclipse.xsl:''' creates a Subclipse PSF from a repository.xml 
***'''repository2subversive.xsl:''' creates a Subversive PSF from a repository.xml 
**'''build.xml:''' the main ant build script : installs Buckminster, imports the dependencies and the Papyrus projects from SVN, builds the workspace, creates the update site and runs the tests
**'''content2html.xsl''': creates an index.html with a user-viewable list of all installable Papyrus plug-ins and features
**'''content2xml.xsl''': creates an index.html with a machine-readable list of all installable Papyrus plug-ins and features
*'''buckminster.cspec :''' describes the top-level dependencies of the build
*'''build.cquery :''' describes the root request for the Buckminster import, properties for the import (for example, it indicates that the Papyrus source plug-ins should not be materialized during the import, as they are generated by Buckminster during the build), and references the Buckminster rmap
*'''build.mspec :''' description for the Buckminster '''materialization''' (i.e. import) of artifacts (plug-ins and features), when building on *.eclipse.org
*'''local.mspec :''' description for the Buckminster materialization when building locally
*'''build.rmap :''' should be updated for each release. An EMF-Facet script allows to update it easily using the b3 file. The tag '''&lt;!-- updateFrom --&gt;''' is used by the script. 
*'''build.properties :''' properties for the build (when building on *.eclipse.org)
*'''local.properties :''' properties for the build (when building locally)


== Build process ==

Taking the example of the job papyrus-trunk-nightly:
* When the Hudson job papyrus-trunk-nightly starts, Hudson begins by doing a checkout of the required folders (which are specified in the job configuration) from the SVN : the "plugins", "features" and "releng" folders are retrieved, and placed under a directory named "sourceTree" in the Hudson workspace.
* Then the first bash script (from the releng project that was just retrieved from the SVN) is executed : "sourceTree/releng/org.eclipse.mdt.papyrus.releng.buckminster/papyrus-trunk-nightly/build-before.sh". This script does a bit of clean-up and initializes variables for the build.
* Then the main build script is executed: "sourceTree/releng/org.eclipse.mdt.papyrus.releng.buckminster/papyrus-trunk-nightly/build.xml":
** it reads the property file '''build.properties''', which defines settings for the build
** it cleans the workspace, target platform and previous build result (depending on the user options specified on Hudson)
** it installs the p2 director, which is used for installing Buckminster
** then it installs Buckminster using the p2 director
** then it materializes the workspace and target platform (using the buckminster '''import''' command). While doing this, it also saves the description of what was materialized into a file named '''papyrus_bom.xml''' (this is called the "bill of materials" in Buckminster's jargon).
** then it builds the workspace using the Buckminster '''build''' command
** then it creates the update site, using the Buckminster '''perform''' command with the '''site.p2''' action on the component "org.eclipse.papyrus.build.feature", which is the feature that contains all the Papyrus features that must be installable from the produced update site
** then it creates an index.html file in the update site, using a XSLT transformation on the update site's content.xml. This index is useful for when users try to display the update site in their web browser : they will then see the plug-ins and features contained by the update site, with an explanation on how they're supposed to be installed
** then it generates PSF files (one for Subclipse and one for Subversive), using XSLT transformations on the '''papyrus_bom.xml''' that was created by Buckminster during the '''import''' step
* Then the second bash script is executed : "sourceTree/releng/org.eclipse.mdt.papyrus.releng.buckminster/papyrus-trunk-nightly/build-after.sh". This script creates the result zip (that contains the zipped update site), and triggers the publication of the result by touching a file that acts as a signal for the cronPromote script that does the publication from build.eclipse.org.

The test builds do one more step: they run the tests using the Buckminster '''test''' command, using an Eclipse launch configuration that references the tests to run.

== Features ==
The feature '''org.eclipse.papyrus.build.feature''' is not visible on the Papyrus Update Site. It is only useful for the Buckminster build. It contains the main Papyrus features : 
* org.eclipse.papyrus.sdk.feature (binary build)
* org.eclipse.papyrus.sdk.source.feature (source build)

The feature '''org.eclipse.papyrus.sdk.feature''' allows to provide the Papyrus binaries on the Update Site. This feature aggregates all the main Papyrus features.

[[Image:binaryFeature.jpeg]]

The feature '''org.eclipse.papyrus.sdk.sources.feature''' allows to provide the Papyrus binaries and the sources on the Update Site. This feature should aggregate the same features as '''org.eclipse.papyrus.sdk.feature''', but each feature is called '''xxx.source.feature''' instead of '''xxx.feature'''. You should have warnings in this file, because the '''xxx.source.feature''' don't exist in your workspace; they will be created during the build. This feature contains '''org.eclipse.papyrus.sdk.feature''' too.

[[Image:sourceFeature.png]]

== Automatic publishing to the downloads server ==
Nightly builds are published automatically to download.eclipse.org.

This part is a bit tricky, as the build server (https://hudson.eclipse.org) and the download server download.eclipse.org are two separate servers, with different access rights. The download server can be accessed by all committers, but the Hudson jobs are launched by a Hudson user that does not have write access to the download server. Thus, publishing results is done in two parts:
*the Hudson task gathers all results and sends a signal to the download server (basically, writing a signal file on the download server, with information on what to publish and where). 
*A cron task that runs every 5 minutes on build.eclipse.org (currently setup under user "vlorenzo") compares the timestamp of the signal file to a reference file. When the signal file is more recent than the reference file, the cron task proceeds to some actions: cleaning the download area (leaving for example only the last 5 nightly builds for each version of the plug-ins), and then getting the results provided by the hudson job to copy them in the right places in the download area. The cron task launches the script cronPromoteMonitor.sh located in ''/opt/public/modeling/mdt/papyrus/'' on build.eclipse.org.

=== Build chaining ===

The publication of papyrus-trunk-nightly triggers the build of papyrus-trunk-extra-nightly and papyrus-trunk-nightly-tests, by using the [http://wiki.hudson-ci.org/display/HUDSON/Remote+access+API Hudson Remote Rccess API], passing it the build id and version as parameters, so that the cronPromote can publish the results of papyrus-trunk-extra-nightly and papyrus-trunk-nightly-tests to the same folder as for the first build.  


== Publishing a build in the aggregator ==
The Eclipse simultaneous release train is built with the B3 aggregator. To be part of the aggregation,  


== Entering the simultaneous release train ==
You should indicate that your project follows the Eclipse Train. Go to the Eclipse portal [https://dev.eclipse.org/portal]. In Eclipse Projects, click on '''view''' : 

[[Image:clickOnView.jpeg]]

click on '''maintain'''

[[Image:clickOnMaintain.jpeg]]

click on edit for '''simultaneousrelease'''

[[Image:clickOnSimultaneousRelease.jpeg]]

add 1 to your new release

[[Image:eclipseTrain.jpeg]]

== What do you select in your build.properties files ? ==
The licence.html file should be selected for both binary and source builds.
The source folder ("src/") should not be selected for the binary nor the source build.

== optimizing the rmap ==
The Buckminster import is very slow (more than one hour and a half) when it does the SVN checkout itself. To optimize it, we let Hudson do the checkout, and we then tell Buckminster to use the locally checked out files.

So, instead of this configuration in the rmap:
 <rm:provider componentTypes="osgi.bundle" readerType="svn">
   <rm:uri format="{0}/modeling/org.eclipse.mdt.papyrus/trunk/plugins/core/{1}">
     <bc:propertyRef key="svn.repository"/>
     <bc:propertyRef key="buckminster.component"/>
   </rm:uri>
 </rm:provider>

We now use the "local" reader:
 <rm:provider componentTypes="osgi.bundle" readerType="local">
   <rm:uri format="{0}/modeling/org.eclipse.mdt.papyrus/trunk/plugins/core/{1}">
     <bc:propertyRef key="local.repository"/>
     <bc:propertyRef key="buckminster.component"/>
   </rm:uri>
 </rm:provider>


